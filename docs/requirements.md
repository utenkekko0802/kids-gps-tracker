# 要件定義書

**バージョン:** 1.0  
**作成日:** 2026年1月21日  
**プロジェクト名:** 子供用GPS通信デバイス

---

## 📋 1. プロジェクト概要

### 1.1 目的
フリーSIMとローカルLLMを活用し、子供に持たせる手のひらサイズのGPS通信デバイスを自作する。市販の見守りGPSにはない音声メッセージ機能を実装し、親子間のコミュニケーションを実現する。

### 1.2 背景
- 市販見守りGPSは位置情報のみで双方向コミュニケーション不可
- スマートフォンは高価で紛失・破損リスクが高い
- 自作により機能カスタマイズと学習機会を得る

### 1.3 スコープ
**対象範囲（In Scope）:**
- GPS位置情報の取得と送信
- 親のLINEへの位置情報通知
- 音声メッセージの送受信（Phase 2）
- ローカルLLMによる緊急度判定（Phase 3）

**対象外（Out of Scope）:**
- リアルタイム通話機能
- カメラ・ディスプレイ機能
- ゲーム・エンターテイメント機能

---

## 🎯 2. 機能要件

### 2.1 Phase 1: GPS位置情報送信（MVP）

| ID | 機能 | 優先度 | 詳細 |
|----|------|--------|------|
| F1-01 | GPS測位 | 必須 | 5分間隔でGPS座標を取得 |
| F1-02 | 位置情報送信 | 必須 | 測位した座標をサーバーに送信 |
| F1-03 | LINE通知 | 必須 | 親のLINEに位置情報URLを送信 |
| F1-04 | バッテリー監視 | 必須 | 残量20%以下で親に警告通知 |
| F1-05 | 手動送信ボタン | 必須 | ボタン押下で即座に位置送信 |
| F1-06 | 受信確認LED | 必須 | サーバーからの応答時にLED点滅 |

### 2.2 Phase 2: 音声メッセージ機能

| ID | 機能 | 優先度 | 詳細 |
|----|------|--------|------|
| F2-01 | 音声録音 | 必須 | ボタン押下で10秒間録音 |
| F2-02 | 音声送信 | 必須 | 録音データをサーバーに送信 |
| F2-03 | 音声テキスト化 | 必須 | Whisper APIで音声→テキスト変換 |
| F2-04 | LINEメッセージ送信 | 必須 | テキストを親のLINEに送信 |
| F2-05 | 返信受信 | 必須 | LINEからの返信をデバイスに転送 |
| F2-06 | テキスト読み上げ | 必須 | 返信テキストを音声化して再生 |
| F2-07 | 受信通知 | 必須 | 返信到着時にLED点灯+通知音 |
| F2-08 | 再生ボタン | 必須 | ボタン押下で最新メッセージ再生 |

### 2.3 Phase 3: LLM判定機能

| ID | 機能 | 優先度 | 詳細 |
|----|------|--------|------|
| F3-01 | 緊急度判定 | 推奨 | Llama 3.2 1Bで音声内容を分析 |
| F3-02 | 優先通知 | 推奨 | 「助けて」等の緊急語句で即座に通知 |
| F3-03 | メッセージ要約 | オプション | 長文メッセージを自動要約 |

---

## 🔧 3. 非機能要件

### 3.1 性能要件

| 項目 | 要件 | 根拠 |
|------|------|------|
| GPS測位精度 | 屋外：±10m以内 | 一般的な民生GPS水準 |
| 測位時間 | コールドスタート：60秒以内 | SIM7080G標準性能 |
| 音声録音品質 | 16kHz / 16bit モノラル | 音声認識に十分な品質 |
| メッセージ送信遅延 | 送信ボタン押下後30秒以内 | ユーザー体感許容範囲 |
| サーバー応答時間 | 95パーセンタイルで3秒以内 | Vercel標準性能 |

### 3.2 信頼性要件

| 項目 | 要件 | 実装方法 |
|------|------|----------|
| バッテリー駆動時間 | 最低7日間（週1充電） | Deep Sleep実装 |
| 通信圏外対応 | 圏外時はローカル保存→復帰後送信 | ESP32のFLASHメモリ利用 |
| データ保全 | 位置情報履歴を30日間保存 | Supabase PostgreSQL |
| 充電忘れ防止 | バッテリー20%で通知 | サーバー側でモニタリング |

### 3.3 ユーザビリティ要件

| 項目 | 要件 |
|------|------|
| ボタン操作 | 小学生が片手で操作可能 |
| 充電方法 | 最終的に磁石ガイド付きQi充電（置くだけ） |
| デバイスサイズ | 60×40×15mm以内（手のひらサイズ） |
| 重量 | 60g以下（子供が気にならない） |
| 防水性能 | 生活防水レベル（IPX4相当を目指す） |

### 3.4 セキュリティ要件

| 項目 | 要件 | 実装方法 |
|------|------|----------|
| 通信暗号化 | すべての通信をHTTPS/TLS | Vercel標準機能 |
| 認証 | デバイスIDによる認証 | Supabase Row Level Security |
| 個人情報保護 | 位置情報は親のみアクセス可能 | RLSポリシー設定 |
| 音声データ | 送信後は即座に削除 | 一時ストレージのみ使用 |

---

## 🛠️ 4. システム構成

### 4.1 アーキテクチャ図

```
┌─────────────────────────────────────┐
│        ESP32デバイス（C++/Arduino）        │
├─────────────────────────────────────┤
│ - GPS測位（TinyGSMライブラリ）          │
│ - LTE通信（HTTP POST）                │
│ - 音声録音/再生（I2S）                  │
│ - Deep Sleep制御                      │
│ - ボタン割り込み処理                    │
└─────────────────────────────────────┘
              ↓ HTTPS
┌─────────────────────────────────────┐
│      Vercel Serverless Functions      │
│         (TypeScript/Next.js)          │
├─────────────────────────────────────┤
│ /api/gps       : GPS座標受信          │
│ /api/voice     : 音声データ受信        │
│ /api/line-webhook : LINE返信受信      │
│ /api/device-message : デバイスへPush  │
└─────────────────────────────────────┘
        ↓                    ↓
┌──────────────┐    ┌──────────────┐
│   Supabase   │    │  外部API      │
├──────────────┤    ├──────────────┤
│ PostgreSQL   │    │ OpenAI       │
│ - gps_logs   │    │ Whisper API  │
│ - messages   │    │              │
│              │    │ LINE         │
│ Realtime     │    │ Messaging    │
│ - Push通知   │    │ API          │
└──────────────┘    └──────────────┘
```

### 4.2 開発環境

| 項目 | 選定技術 |
|------|---------|
| デバイス開発 | Arduino IDE 2.x / PlatformIO |
| デバイス言語 | C++ (Arduino Framework) |
| サーバー開発 | Visual Studio Code |
| サーバー言語 | TypeScript |
| サーバーフレームワーク | Next.js 14 (App Router) |
| データベース | Supabase PostgreSQL |
| ホスティング | Vercel (Serverless Functions) |
| バージョン管理 | Git + GitHub |

---

## 📡 5. 通信仕様

### 5.1 SIM契約

| 項目 | 仕様 |
|------|------|
| キャリア | IIJmio データeSIM / 物理SIM |
| プラン | eSIMデータプラン ライトスタート |
| 月額料金 | 440円（税込） |
| データ容量 | 2GB/月 |
| 想定使用量 | 約500MB/月（GPS: 100MB、音声: 400MB） |
| APN | iijmio.jp |
| ユーザー名 | mio@iij |
| パスワード | iij |

### 5.2 通信プロトコル

**GPS位置情報送信（Phase 1）:**
```json
POST https://your-app.vercel.app/api/gps
Content-Type: application/json

{
  "device_id": "device_001",
  "latitude": 35.6812,
  "longitude": 139.7671,
  "accuracy": 10,
  "battery_level": 85,
  "timestamp": "2026-01-21T10:30:00Z"
}
```

**音声メッセージ送信（Phase 2）:**
```http
POST https://your-app.vercel.app/api/voice
Content-Type: multipart/form-data

device_id: device_001
audio: [binary WAV data]
duration: 10
timestamp: 2026-01-21T10:30:00Z
```

### 5.3 LINE連携仕様

| 項目 | 仕様 |
|------|------|
| LINE Bot種別 | LINE Messaging API |
| 通知形式 | Flex Message（地図リンク付き） |
| 位置情報表示 | Google Maps URL |
| 音声メッセージ | テキスト変換後に送信 |
| 返信方法 | LINE上でテキスト返信 |

---

## 🔋 6. 電力設計

### 6.1 消費電力試算（最適化後）

| 動作モード | 消費電力 | 継続時間 | 1日あたり消費 |
|-----------|---------|---------|--------------|
| Deep Sleep | 5mA | 23時間50分 | 119mAh |
| GPS測位 | 50mA | 5分（12回/日） | 50mAh |
| LTE通信 | 100mA | 1分（12回/日） | 20mAh |
| ボタン待機 | 0.1mA | 24時間 | 2.4mAh |
| **合計** | - | - | **約191mAh/日** |

**バッテリー持ち計算:**
- 3,000mAhバッテリー使用時: 3,000 ÷ 191 = **約15日間**
- 安全マージン考慮: **約10-12日間（週1充電に余裕）**

### 6.2 省電力化実装

```cpp
void loop() {
  // GPS測位
  getGPSLocation();
  
  // データ送信
  sendToServer();
  
  // LTE完全切断
  modem.gprsDisconnect();
  modem.poweroff();
  
  // 5分間Deep Sleep
  esp_sleep_enable_timer_wakeup(300 * 1000000);
  esp_deep_sleep_start();
}
```

---

## 💰 7. コスト試算

### 7.1 初期費用

| Phase | 内容 | 金額 |
|-------|------|------|
| Phase 1 | GPS基本機能 | 13,000円 |
| Phase 2 | 音声機能追加 | +2,300円 |
| Phase 3 | LLM機能（サーバーのみ） | 0円 |
| Phase 4 | Qi充電化 | +3,200円 |
| **最終合計** | - | **18,500円** |

### 7.2 ランニングコスト

| 項目 | 月額 | 年額 |
|------|------|------|
| IIJmio SIM | 440円 | 5,280円 |
| Vercel | 0円 | 0円 |
| Supabase | 0円 | 0円 |
| OpenAI Whisper API | 約100円 | 約1,200円 |
| LINE Messaging API | 0円 | 0円 |
| **合計** | **約540円** | **約6,480円** |

※音声メッセージを1日3回、月90回送信と想定

### 7.3 市販品との比較

| 項目 | 自作デバイス | 市販GPS（参考） |
|------|------------|---------------|
| 初期費用 | 18,500円 | 5,000-8,000円 |
| 月額費用 | 540円 | 528-748円 |
| GPS機能 | ○ | ◎ |
| 音声メッセージ | ◎ | × |
| バッテリー | 週1充電 | 1-2ヶ月 |
| カスタマイズ性 | ◎ | × |
| 学習価値 | ◎ | × |

---

## ⚠️ 8. リスクと対策

### 8.1 技術リスク

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|--------|------|
| GPS測位精度不足 | 中 | 高 | 外付けアンテナ使用、複数衛星対応 |
| 音声認識精度低下 | 中 | 中 | Whisper large-v3使用、ノイズ対策 |
| バッテリー持ち不足 | 中 | 高 | Deep Sleep最適化、3,000mAhバッテリー |
| LTE接続不安定 | 低 | 高 | オフライン保存機能、再送処理実装 |
| Qi充電位置ずれ | 中 | 中 | 磁石ガイド実装、視覚的フィードバック |

### 8.2 運用リスク

| リスク | 発生確率 | 影響度 | 対策 |
|-------|---------|--------|------|
| 充電忘れ | 高 | 高 | 20%以下で親に通知、玄関充電の習慣化 |
| デバイス紛失 | 中 | 中 | GPS履歴で最終位置確認 |
| 防水性不足 | 中 | 中 | 生活防水ケース検討、防水テスト実施 |
| 子供の操作ミス | 中 | 低 | シンプルなUI、誤操作防止設計 |

---

## ✅ 9. 受入基準

### 9.1 Phase 1完了条件

- [ ] ESP32からGPS座標を5分間隔で取得できる
- [ ] Supabaseにデータが正常に保存される
- [ ] 親のLINEに位置情報通知が届く
- [ ] バッテリー残量が正しく表示される
- [ ] 手動送信ボタンで即座に位置送信できる
- [ ] Deep Sleep実装で7日間以上駆動する

### 9.2 Phase 2完了条件

- [ ] マイクで10秒間の音声録音ができる
- [ ] 音声データがサーバーに送信される
- [ ] Whisper APIでテキスト変換される
- [ ] 変換されたテキストがLINEに届く
- [ ] LINE返信がデバイスに届く
- [ ] スピーカーで返信が音声再生される

### 9.3 Phase 3完了条件

- [ ] 「助けて」等の緊急語句を検出できる
- [ ] 緊急時は即座に通知される
- [ ] 通常メッセージは適切に処理される

### 9.4 Phase 4完了条件

- [ ] Qi充電パッドに置くと充電開始
- [ ] 磁石ガイドで自動位置合わせ
- [ ] 3時間以内にフル充電完了
- [ ] ケースに収まり持ち運べる

---

## 📝 変更履歴

| バージョン | 日付 | 変更内容 | 変更者 |
|-----------|------|---------|--------|
| 1.0 | 2026-01-21 | 初版作成 | Koichi |
| 1.1 | 2026-01-21 | SIM7000G→SIM7080Gに修正 | Koichi |
